---
title: Browser EventLoop
date: 2021-04-28 10:28:48
cover: https://cdn.jsdelivr.net/gh/Wangbaoqi/blogImgs@master/nateImgs/browser/bg/event.png
tags: 
  - Browser
categories: 
  - Browser
---

> äº‹ä»¶å¾ªç¯æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆä¼šæœ‰äº‹ä»¶å¾ªç¯æœºåˆ¶ï¼Ÿ JSæ˜¯å•çº¿ç¨‹çš„è¯­è¨€ï¼Œå¦‚æœåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°å¼‚æ­¥çš„ä»£ç ï¼Œä¸å¯èƒ½ä¸€ç›´ç­‰å¾…ï¼ˆæµªè´¹èµ„æºã€‚ã€‚ã€‚ï¼‰, è‡³æ­¤ï¼Œäº‹ä»¶å¾ªç¯æœºåˆ¶å°±è¿ç”¨è€Œç”Ÿäº†ã€‚

åœ¨äº†è§£EventLoopä¹‹å‰ï¼Œé¦–å…ˆå†ç¨³å›ºä¸€ä¸‹JavaScriptä»£ç çš„æ‰§è¡Œæœºåˆ¶

## JavaScript æ‰§è¡Œé¡ºåº

åœ¨é‡åˆ°ä¸€æ®µJSä»£ç æ—¶ï¼Œå®ƒçš„æ‰§è¡Œé¡ºåºè¡¨é¢çœ‹æ˜¯æŒ‰ç…§é¡ºåºæ‰§è¡Œï¼Œä½†æ˜¯å†…éƒ¨å…¶å®ä¸ç„¶ã€‚ **ä¸€æ®µJSåœ¨æ‰§è¡Œä¹‹å‰ï¼Œé¦–å…ˆä¼šè¢«ç¼–è¯‘å™¨è¿›è¡Œç¼–è¯‘ï¼Œä¹‹åä¼šåœ¨JSå¼•æ“çš„æ§åˆ¶ä¸‹æ‰§è¡Œä»£ç **

![JSæ‰§è¡Œé¡ºåº](https://cdn.jsdelivr.net/gh/Wangbaoqi/blogImgs@master/nateImgs/browser/event/event_1.png)

**æ‰§è¡Œä¸Šä¸‹æ–‡**

![æ‰§è¡Œä¸Šä¸‹æ–‡](https://cdn.jsdelivr.net/gh/Wangbaoqi/blogImgs@master/nateImgs/browser/event/event_2.png)

### ç¼–è¯‘é˜¶æ®µ

åœ¨ä¸€æ®µä»£ç ç¼–è¯‘ä¹‹åï¼Œä¼šç”Ÿæˆä¸¤éƒ¨åˆ†å†…å®¹ï¼š

1. æ‰§è¡Œä¸Šä¸‹æ–‡ - å½“å‰JSä»£ç æ‰§è¡Œçš„è¿è¡Œç¯å¢ƒ
2. å¯æ‰§è¡Œä»£ç 

**æ‰§è¡Œä¸Šä¸‹æ–‡**

æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­åˆåŒ…å«äº†å˜é‡ç¯å¢ƒå¯¹è±¡ï¼ˆvariable environmentï¼‰å’Œè¯æ³•ç¯å¢ƒ

å˜é‡ç¯å¢ƒå¯¹è±¡ä¸­åŒ…å«äº†è¿™æ®µä»£ç ä¸­æ‰€æœ‰çš„å£°æ˜ã€‚

```javascript
foo();
console.log(bar);
var bar = 3;
function foo() {
  console.log('excute fo');
}
```

åˆ†æä¸Šé¢çš„ğŸŒ°:

```javascript
// ç¯å¢ƒå˜é‡ å¯¹è±¡
variable environment {
  bar -> undefined
  foo -> function() { ... }
}
```

åœ¨æ‰§è¡Œé˜¶æ®µï¼ŒJSå¼•æ“ä¼šæŒ‰ç…§é¡ºåºæ‰§è¡Œå¯æ‰§è¡Œä»£ç ã€‚

### æ‰§è¡Œä¸Šä¸‹æ–‡

æ‰§è¡Œä¸Šä¸‹æ–‡æ˜¯åœ¨ç¼–è¯‘é˜¶æ®µäº§ç”Ÿçš„ï¼Œåœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šåˆ›å»ºæ‰§è¡Œä¸Šä¸‹æ–‡å‘¢ï¼Ÿ

1. å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡ - æ‰§è¡Œå…¨å±€ä»£ç 

2. å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡ - æ‰§è¡Œå‡½æ•°ä»£ç 

3. evalæ‰§è¡Œä¸Šä¸‹æ–‡ - æ‰§è¡Œevalå‡½æ•°

### è°ƒç”¨æ ˆ

è°ƒç”¨æ ˆåˆç§°ä¸ºæ‰§è¡Œä¸Šä¸‹æ–‡æ ˆ - ç®¡ç†æ‰§è¡Œä¸Šä¸‹æ–‡çš„æ ˆ

ä¸‹é¢é€šè¿‡ç®€å•çš„ä¾‹å­æ¥è¯´æ˜è°ƒç”¨æ ˆ

```javascript
var a = 2;
function addAll(b) {
  return add(x, y)
}
function add(a, b) {
  return a + b
}
addAll(5)
```

é¦–å…ˆç¼–è¯‘å…¨å±€ä»£ç äº§ç”Ÿå…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œå…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡å…¥æ ˆï¼Œå…¶å˜é‡ç¯å¢ƒå¯¹è±¡ä¸º:

```javascript
variable environment {
  a -> undefined
  addAll -> function() { add(x, y) }
  add -> function() { return a + b }
}
```

æ¥ç€æ‰§è¡Œå…¨å±€å¯æ‰§è¡Œä»£ç ï¼ša = 2, addAll();

åœ¨æ‰§è¡ŒaddAllå‡½æ•°æ—¶ï¼Œç¼–è¯‘äº§ç”Ÿäº†addAllæ‰§è¡Œä¸Šä¸‹æ–‡æ ˆï¼Œå…¥æ ˆï¼Œå…¶å˜é‡ç¯å¢ƒå¯¹è±¡ä¸º:

```javascript
variable environment {
  ... // ä¸ºç©º
}
```

ä¸‹ä¸€æ­¥æ‰§è¡ŒaddAllä¸­å¯æ‰§è¡Œä»£ç  addå‡½æ•°ï¼Œè¿›è¡Œç¼–è¯‘ä¹‹åäº§ç”Ÿäº†addæ‰§è¡Œä¸Šä¸‹æ–‡æ ˆï¼Œå…¥æ ˆï¼Œå˜é‡ç¯å¢ƒå¯¹è±¡ä¾ç„¶ä¸ºç©ºã€‚æ‰§è¡Œaddä¸­çš„å¯æ‰§è¡Œä»£ç ã€‚

æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œè°ƒç”¨æ ˆå¼¹å‡ºaddæ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œç´§æ¥ç€åˆå¼¹å‡ºaddAllæ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œæœ€ç»ˆè°ƒç”¨æ ˆä¸­åªæœ‰å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡

**è°ƒç”¨æ ˆå¯ä»¥æŸ¥çœ‹ä»£ç çš„æ‰§è¡Œé¡ºåºï¼Œä»¥åŠä»£ç ä¹‹é—´çš„è°ƒç”¨å…³ç³»ï¼Œæ’æŸ¥bugæ˜¯éå¸¸ä¾¿æ·çš„**

**æ ˆæº¢å‡º**

è°ƒç”¨æ ˆä¹Ÿæ˜¯æœ‰å¤§å°çš„ï¼Œæ ˆæº¢å‡ºè¿™ç§é—®é¢˜åœ¨å¼€å‘ä¸­å‡ºç°çš„æ¦‚ç‡ä¹Ÿä¸å°ã€‚å¦‚æœå‡½æ•°é€’å½’è°ƒç”¨å¹¶ä¸”æ²¡æœ‰ç»“æŸæ¡ä»¶çš„æ—¶å€™ï¼Œé€šå¸¸ä¼šäº§ç”Ÿæ ˆæº¢å‡º

## åˆæ¢äº‹ä»¶å¾ªç¯ã€æ¶ˆæ¯é˜Ÿåˆ—

**ç¼˜ç”±: æ¸²æŸ“è¿›ç¨‹éƒ½ä¼šæœ‰ä¸€ä¸ªä¸»çº¿ç¨‹ï¼Œè€Œè¿™ä¸ªä¸»çº¿ç¨‹ä¼šå¤„ç†ä¸åŒçš„ä»»åŠ¡ï¼ŒDOMæ¸²æŸ“ï¼Œè®¡ç®—æ ·å¼ï¼Œè„šæœ¬æ‰§è¡Œï¼Œç”¨æˆ·è¾“å…¥ï¼Œå¼‚æ­¥ä»»åŠ¡ç­‰**

1. åœ¨å•çº¿ç¨‹ä¸­å¤„ç†å·²å®‰æ’å¥½çš„ä»»åŠ¡ 

```javascript
function MainThread() {
  const a = 1 + 1;
  const b = 2/1;
  const c = 4*3;
  console.log(a,b,c)
}
```

2. åœ¨å•çº¿ç¨‹ä¸­å¤„ç†æ–°åŠ å…¥çš„ä»»åŠ¡ 

**è¦åœ¨çº¿ç¨‹è¿è¡Œçš„è¿‡ç¨‹ä¸­å¤„ç†æ–°åŠ å…¥çš„ä»»åŠ¡ï¼Œå°±éœ€è¦é‡‡ç”¨äº‹ä»¶å¾ªç¯æœºåˆ¶äº†**

![å¾ªç¯æœºåˆ¶](https://cdn.jsdelivr.net/gh/Wangbaoqi/blogImgs@master/nateImgs/browser/event/event_3.png)

```javascript
function getInput(val) {
  return val
}
// ä¸»çº¿ç¨‹ ç­‰å¾…ç”¨æˆ·çš„è¾“å…¥
function MainThread() {
  for(;;) {
    let firstNum = getInput(3)
    let secondNum = getInput(4)
    console.log(firstNum + secondNum)
  }
}
```

1. åœ¨å•çº¿ç¨‹ä¸­å¤„ç†å…¶ä»–çº¿ç¨‹å‘é€çš„ä»»åŠ¡

**ç”¨ç¬¬äºŒç‰ˆçº¿ç¨‹æ˜¯æ— æ³•å¤„ç†å…¶ä»–çº¿ç¨‹å‘é€çš„ä»»åŠ¡çš„ï¼Œå› æ­¤ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å°±äº§ç”Ÿäº†**

### æ¶ˆæ¯é˜Ÿåˆ—

![æ¶ˆæ¯é˜Ÿåˆ—](https://cdn.jsdelivr.net/gh/Wangbaoqi/blogImgs@master/nateImgs/browser/event/event_4.png)

æ¶ˆæ¯é˜Ÿåˆ—ä¸­æœ‰å¾ˆå¤šçš„ä»»åŠ¡ç±»å‹ï¼ˆè¾“å…¥äº‹ä»¶-é¼ æ ‡æ»šåŠ¨ã€ç‚¹å‡»ã€ç§»åŠ¨ï¼Œå¾®ä»»åŠ¡ï¼Œæ–‡ä»¶è¯»å†™ã€websocketã€å®šæ—¶å™¨ç­‰ï¼‰, æ¯å½“æœ‰æ–°çš„çº¿ç¨‹çš„ä»»åŠ¡æ¥çš„æ—¶å€™ï¼Œå°±ä¼šè¿›å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…ä¸»çº¿ç¨‹ä¸­çš„ä»»åŠ¡æ‰§è¡Œå®Œæˆä¹‹åå†æ‰§è¡Œã€‚

![eventLoop](https://cdn.jsdelivr.net/gh/Wangbaoqi/blogImgs@master/nateImgs/browser/event/event_5.png)

**é¡µé¢ä½¿ç”¨å•çº¿ç¨‹çš„ç¼ºç‚¹**

1. å¤„ç†ä¼˜å…ˆçº§é«˜çš„ä»»åŠ¡ 

æ¯”è¾ƒå…¸å‹çš„åœºæ™¯å°±æ˜¯ç›‘æ§DOMèŠ‚ç‚¹å˜åŒ–çš„æƒ…å†µï¼Œé€šç”¨çš„åšæ³•æ˜¯åˆ©ç”¨JavaScriptè®¾è®¡ä¸€å¥—ç›‘å¬ç³»ç»Ÿï¼Œå½“æ•°æ®å˜åŒ–æ—¶ï¼Œæ¸²æŸ“å¼•æ“åŒæ­¥è°ƒç”¨æ¥å£ï¼Œä¹Ÿå°±æ˜¯å…¸å‹çš„è§‚å¯Ÿè€…æ¨¡å¼

* å½“DOMé¢‘ç¹çš„è°ƒç”¨æ—¶ï¼Œç›´æ¥è°ƒç”¨æ¸²æŸ“çš„æ¥å£**ä¸»çº¿ç¨‹æ‰§è¡Œ**ï¼Œä¼šå¯¼è‡´ä»»åŠ¡æ‰§è¡Œæ—¶é—´çš„æ‹‰é•¿ï¼Œä»è€Œå¯¼è‡´æ‰§è¡Œæ•ˆç‡çš„ä¸‹é™
* å¦‚æœæŠŠDOMå˜åŒ–æˆå¼‚æ­¥æ“ä½œåŠ å…¥åˆ°é˜Ÿåˆ—é‡Œï¼Œåˆå¤±å»äº†ç›‘æ§çš„æ—¶æ•ˆæ€§

åŸºäºä¸Šè¿°ä¸¤ç‚¹ï¼Œ**å¾®ä»»åŠ¡**å‡ºç°äº†

é€šå¸¸å°†æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ç§°ä¸º**å®ä»»åŠ¡**ï¼Œæ¯ä¸ªå®ä»»åŠ¡ä¸­åŒ…å«ä¸€ä¸ªå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œåœ¨æ‰§è¡Œå®ä»»åŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæœ‰DOMæœ‰å˜åŒ–ï¼Œä¼šå°†è¿™äº›æ“ä½œDOMçš„æ“ä½œä¿å­˜åœ¨å¾®ä»»åŠ¡ä¸­ï¼Œè¿™æ ·å°±è§£å†³äº†å®æ—¶æ€§é—®é¢˜

2. å¦‚ä½•è§£å†³å•ä¸ªä»»åŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿é—®é¢˜

å› ä¸ºæ‰€æœ‰ä»»åŠ¡éƒ½æ˜¯åœ¨å•çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œå¦‚æœæŸä¸ªä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´è¿‡é•¿ï¼Œåˆ™ä¼šå½±å“ç”¨æˆ·çš„ä½“éªŒã€‚

æ‰€ä»¥æµè§ˆå™¨é‡‡ç”¨äº†**å›è°ƒ**çš„æ–¹å¼æ¥è§„é¿è¿™ç§é—®é¢˜

## äº‹ä»¶å¾ªç¯setTimeout

ä»ä¸Šè¿°çŸ¥é“äº†æµè§ˆå™¨é¡µé¢æ˜¯ç”±äº‹ä»¶å¾ªç¯å’Œæ¶ˆæ¯é˜Ÿåˆ—æ¥é©±åŠ¨ã€‚

åœ¨è¿™éƒ¨åˆ†ä¸»è¦å­¦ä¹ äº‹ä»¶å¾ªç¯çš„åº”ç”¨ï¼Œå…¸å‹çš„æœ‰setTimeoutå’ŒXMLHttpRequest è¿™ä¸¤ä¸ªwebAPI

**setTimeout**å®šæ—¶å™¨

ä¼šè¿”å›ä¸€ä¸ªæ•´æ•°ï¼ˆå®šæ—¶å™¨çš„ç¼–å·ï¼‰ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªç¼–å·æ¥å–æ¶ˆå®šæ—¶å™¨

æµè§ˆå™¨å®ç°å®šæ—¶å™¨

åœ¨äº‹ä»¶å¾ªç¯ç³»ç»Ÿä¸­ï¼Œæ‰€æœ‰è¿è¡Œåœ¨ä¸»çº¿ç¨‹ï¼ˆæ¸²æŸ“çº¿ç¨‹ï¼‰ä¸­çš„ä»»åŠ¡éƒ½éœ€è¦éœ€è¦å…ˆæ·»åŠ åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç„¶åå†æ ¹æ®é¡ºåºä¾æ¬¡æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚

å…¸å‹çš„äº‹ä»¶:

* æ¥æ”¶HTMLæ–‡æ¡£ï¼Œæ¸²æŸ“å¼•æ“å°±ä¼šå°†â€œè§£æDOMâ€äº‹ä»¶æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­
* æ”¹å˜webé¡µé¢çš„çª—å£å¤§å°ï¼Œå½“åšâ€œé‡æ–°å¸ƒå±€â€äº‹ä»¶æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­
* è§¦å‘åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œå½“åšâ€œåƒåœ¾å›æ”¶â€ä»»åŠ¡æ·»åŠ é˜Ÿåˆ—ä¸­
* æ‰§è¡Œä¸€æ®µå¼‚æ­¥ä»£ç ï¼Œä¹Ÿæ˜¯å°†æ‰§è¡Œä»»åŠ¡æ·»åŠ åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­

ä¹Ÿå°±æ˜¯è¯´æ‰§è¡Œä¸€æ®µå¼‚æ­¥ä»£ç ï¼Œé¦–å…ˆä¼šå°†ä»»åŠ¡æ·»åŠ åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ã€‚è€Œé€šè¿‡å®šæ—¶å™¨è®¾ç½®çš„å›è°ƒå‡½æ•°ï¼Œæ˜¯é€šè¿‡ä¸€æ®µæ—¶é—´é—´éš”æ¥æ‰§è¡Œçš„ã€‚ä¸ºäº†ç¡®ä¿åœ¨æ­£ç¡®çš„æ—¶é—´å†…æ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œä¸èƒ½å°†å›è°ƒå‡½æ•°æ·»åŠ åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ã€‚

å› æ­¤ï¼Œå‡ºç°äº†**å¼‚æ­¥é˜Ÿåˆ—**(çœŸæ­£æ˜¯ä¸€ä¸ªhashmap)ï¼Œè¿™ä¸ªé˜Ÿåˆ—ä¸­ç»´æŠ¤äº†éœ€è¦å»¶è¿Ÿæ‰§è¡Œçš„ä»»åŠ¡ã€‚æ‰€ä»¥ï¼Œå½“è°ƒç”¨setTimeoutæ—¶ï¼Œæ¸²æŸ“è¿›ç¨‹ä¼šå°†è¯¥å®šæ—¶å™¨çš„å›è°ƒä»»åŠ¡æ·»åŠ åˆ°å¼‚æ­¥é˜Ÿåˆ—ä¸­ï¼ˆè®°å½•å½“å‰æ—¶é—´æˆ³ã€å»¶è¿Ÿæ—¶é—´ä»¥åŠå›è°ƒå‡½æ•°ï¼‰ï¼Œç­‰åˆ°å½“å‰æ‰§è¡Œçš„ä»»åŠ¡æ‰§è¡Œç»“æŸä¹‹åï¼Œå°±ä¼šæ‰§è¡Œè¯¥å¼‚æ­¥é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼ˆæ ¹æ®å½“å‰çš„æ—¶é—´è®¡ç®—å‡ºåˆ°æœŸçš„ä»»åŠ¡ï¼Œä¸€æ¬¡æ‰§è¡Œä»»åŠ¡ï¼‰ï¼Œæ‰§è¡Œç»“æŸï¼Œå°±ä¼šåˆ°ä¸‹ä¸€ä¸ªå¾ªç¯è¿‡ç¨‹(æ¶ˆæ¯é˜Ÿåˆ—è·å–ä»»åŠ¡ï¼Œé‡æ–°å¼€å§‹)

**ä½¿ç”¨setTimeoutæ³¨æ„äº‹é¡¹**

1. å¦‚æœå½“å‰ä»»åŠ¡æ‰§è¡Œæ—¶é—´è¿‡ä¹…ï¼Œä¼šå½±å“å®šæ—¶å™¨ä»»åŠ¡çš„æ‰§è¡Œ

```javascript
function foo() {
  setTimeout(() => {
    console.log('setTimeout')
  }, 0)
  // å½“å‰ä»»åŠ¡å¾ªç¯5000 æ‰§è¡Œæ—¶é—´å¯èƒ½è¿‡é•¿
  for(let i = 0; i < 5000; i++) {
    console.log(i)
  }
}
```

2. å¦‚æœsetTimeoutå­˜åœ¨åµŒå¥—è°ƒç”¨ï¼Œç³»ç»Ÿä¼šè®¾ç½®æœ€çŸ­æ—¶é—´é—´éš”ä¸º4æ¯«ç§’

```javascript
function cb() { setTimeout(cb, 0)}
setTimeout(cb, 0)
```

å¦‚æœåµŒå¥—è°ƒç”¨5æ¬¡ä»¥ä¸Šï¼Œä¹‹åæ¯æ¬¡è°ƒç”¨çš„æœ€å°æ—¶é—´é—´éš”ä¸º4æ¯«ç§’ï¼ˆè®¾ç½®4æ¯«ç§’ä»¥ä¸‹ï¼‰ï¼Œç³»ç»Ÿä¼šåˆ¤å®šè¯¥å‡½æ•°é˜»å¡äº†

3. æœªæ¿€æ´»çš„é¡µé¢ï¼ŒsetTimeoutæ‰§è¡Œæœ€å°é—´éš”ä¸º1000æ¯«ç§’

å¦‚æœæœªæ¿€æ´»çš„é¡µé¢æˆ–è€…å¤„äºåå°çš„é¡µé¢ä½¿ç”¨setTimeoutæ—¶ï¼Œæœ€å°é—´éš”çš„æ—¶é—´ä¸º1s,ç›®çš„æ˜¯é™ä½è€—ç”µé‡ä»¥åŠä¼˜åŒ–åå°é¡µé¢åŠ è½½æŸè€—

4. å»¶è¿Ÿæ‰§è¡Œçš„æœ€å¤§æ—¶é—´é—´éš”

é‚£å°±æ˜¯ `Chrome`ã€`Safari`ã€`Firefox` éƒ½æ˜¯ä»¥ 32 ä¸ª `bit` æ¥å­˜å‚¨å»¶æ—¶å€¼çš„ï¼Œ32bit æœ€å¤§åªèƒ½å­˜æ”¾çš„æ•°å­—æ˜¯ 2147483647 æ¯«ç§’ï¼Œè¿™å°±æ„å‘³ç€ï¼Œå¦‚æœ setTimeout è®¾ç½®çš„å»¶è¿Ÿå€¼å¤§äº `2147483647` æ¯«ç§’ï¼ˆå¤§çº¦ 24.8 å¤©ï¼‰æ—¶å°±ä¼šæº¢å‡ºï¼Œé‚£ä¹ˆç›¸å½“äºå»¶æ—¶å€¼è¢«è®¾ç½®ä¸º 0,è¿™å¯¼è‡´å®šæ—¶å™¨ä¼šè¢«ç«‹å³æ‰§è¡Œ

5. å›è°ƒå‡½æ•°ä¸­this

```javascript
var obj = {
  a: 2,
  foo: function() {
    console.log('foo', this.a)
  }
}
setTimeout(obj.foo, 0) // foo undefined

// æ”¹è¿›æ–¹å¼ 1. bind
setTimeout(obj.foo.bind(obj), 0) // bind 
// æ”¹è¿›æ–¹å¼ 2. => 
setTimeout(() => {
  obj.foo()
}, 0)
```

å…³äº[requestAnimationFrame](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestAnimationFrame)

### äº‹ä»¶å¾ªç¯XMLHttpRequest

å›è°ƒå‡½æ•°å’Œç³»ç»Ÿè°ƒç”¨æ ˆ å›è°ƒå‡½æ•°éƒ½ä¸ä¼šé™Œç”Ÿï¼Œå®ƒæœ‰ä¸¤ç§æ–¹å¼: åŒæ­¥å›è°ƒå’Œå¼‚æ­¥å›è°ƒ

1. åŒæ­¥å›è°ƒ - ä¸»å‡½æ•°ä¸­æ‰§è¡Œ

```javascript
function main(cb) {
  var a = 9
  console.log(a + 9)
  cb()
  console.log(a + 8)
}
function foo() (
  console.log(6)
)
main(foo)
```

1. å¼‚æ­¥å›è°ƒ = ä¸»å‡½æ•°ä¹‹å¤–æ‰§è¡Œ

```javascript
function main(cb) {
  var a = 9
  console.log(a + 9)
  setTimeout(cb, 0)
  console.log(a + 8)
}
function foo() (
  console.log(6)
)
main(foo)
```

**XMLHttpRequest è¿è¡Œæœºåˆ¶**

![xmlHttpRequest](https://cdn.jsdelivr.net/gh/Wangbaoqi/blogImgs@master/nateImgs/JavaScript/ctx/event\_6.png)

ä¸Šå›¾æ˜¯XMLHttpRequestçš„æ€»æ‰§è¡Œå›¾, ä¸‹é¢çœ‹XMLHttpRequestçš„è¯¦ç»†ç”¨æ³•

```javascript
function fetchData(url) {
  // 1. create xmlHttpRequset Object
  let xhr = new XMLHttpRequest()

  // 2. register callback fucntion 
  xhr.onreadystatechange = function() {
    switch(xhr.readyState) {
      case 0:  // è¯·æ±‚æœªåˆå§‹åŒ–
        console.log('è¯·æ±‚æœªåˆå§‹åŒ–');
        break
      case 1: // opened
        console.log('opened');
        break
      case 2: // headers_received
        console.log('headers_received');
        break
      case 3: // loading
        console.log('loading');
        break
      case 4: // DONE
        console.log('DONE');
        if(this.status == 200 || this.status == 304) {
          conosle.log(this.responseText)
        }
        break
    }
  }

  xhr.ontimeout = function(e) { console.log('ontimeout' )}
  xhr.onerror = function(e) { console.log('onerror' )}

  // 3. open request
  xhr.open('Get', url, true) // create async request


  // 4. config param
  xhr.timeout = 3000 // set timeout
  xhr.responseType = 'text' // set response data type 
  xhr.setRequestHeader('X_Test', 'time.cn') 

  // 5. send request
  xhr.send()
}
```

**ä½¿ç”¨XMLHttpRequestçš„é—®é¢˜**

1. è·¨åŸŸé—®é¢˜
  ç”±äºæµè§ˆå™¨çš„å®‰å…¨ç­–ç•¥ä»¥åŠåŒæºç­–ç•¥é™åˆ¶ï¼Œåªèƒ½è¯·æ±‚åŒæºçš„æœåŠ¡åœ°å€
2. HTTPSæ··å…¥é—®é¢˜
  HTTPsé¡µé¢ä¸­ä½¿ç”¨äº†HTTPèµ„æºï¼ŒåŒ…æ‹¬å›¾ç‰‡ï¼Œè§†é¢‘ç­‰ï¼Œè¿™æ—¶æµè§ˆå™¨ä¼šå‘å‡ºè­¦å‘Š

### å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡

ä¸Šè¿°å­¦ä¹ äº†é¡µé¢çš„è¿è½¬æ˜¯ç”±æ¶ˆæ¯é˜Ÿåˆ—å’Œå¾ªç¯ç³»ç»Ÿæ¥é©±åŠ¨çš„ï¼Œé€šè¿‡setTimeoutå’Œ`XMLHTTPRequest`ä¸¤ä¸ªwebAPIæ·±å…¥äº†è§£äº†æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆåŒ…æ‹¬å¼‚æ­¥é˜Ÿåˆ—ï¼‰ï¼Œè¿™äº›é˜Ÿåˆ—ä¸­ä¼šæœ‰å¾ˆå¤šçš„ä»»åŠ¡ï¼Œè€Œè¿™äº›ä»»åŠ¡éƒ½æ˜¯å®ä»»åŠ¡ã€‚éšç€æµè§ˆå™¨çš„åº”ç”¨è¶Šæ¥è¶Šå¹¿æ³›ï¼Œå¯¹`å®æ—¶æ€§`å’Œ`æ•ˆç‡`è¦æ±‚è¶Šæ¥è¶Šé«˜ã€‚

è€Œè¿™äº›`å®æ—¶æ€§`å’Œ`æ•ˆç‡`çš„å‡ºç°ï¼Œä¹Ÿå°±éšä¹‹å‡ºç°äº†`å¾®ä»»åŠ¡`ï¼Œå¾®ä»»åŠ¡å¯ä»¥åœ¨å®æ—¶æ€§å’Œæ•ˆç‡ä¹‹é—´åšä¸€ä¸ªæƒè¡¡ã€‚

ä½†æ˜¯ï¼Œä»€ä¹ˆæŠ€æœ¯ä¼šç”¨åˆ°å¾®ä»»åŠ¡å‘¢ï¼Œæˆ–è€…è¯´æ˜¯å¾®ä»»åŠ¡çš„åº”ç”¨åœºæ™¯æœ‰å“ªäº›å‘¢ï¼Ÿæ˜¯æ€ä¹ˆæ ·æƒè¡¡å®æ—¶æ€§å’Œæ•ˆç‡ä¹‹é—´çš„å¹³è¡¡çš„å‘¢ï¼Ÿ

å¸¦ç€è¿™äº›é—®é¢˜æ¥å­¦ä¹ ä¸€äº›å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡ã€‚

#### å®ä»»åŠ¡

é¡µé¢ä¸­çš„å¤§éƒ¨åˆ†ä»»åŠ¡éƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œçš„ï¼Œè¿™äº›ä»»åŠ¡åŒ…æ‹¬ï¼š

* æ¸²æŸ“äº‹ä»¶ - è§£æDOM è®¡ç®—å¸ƒå±€ ç»˜åˆ¶
* ç”¨æˆ·äº¤äº’ - ç‚¹å‡» é¡µé¢æ»šåŠ¨ 
* JSè„šæœ¬æ‰§è¡Œ 
* ç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶æ–‡ä»¶è¯»å†™å®Œæˆ 

ä¸ºäº†åè°ƒè¿™äº›ä»»åŠ¡æœ‰æ¡ä¸ç´Šçš„æ‰§è¡Œï¼Œé¡µé¢è¿›ç¨‹å¼•è¿›äº†æ¶ˆæ¯é˜Ÿåˆ—å’Œäº‹ä»¶å¾ªç¯ç³»ç»Ÿã€‚ä¸»è¿›ç¨‹é‡‡ç”¨forå¾ªç¯ï¼Œä¸æ–­çš„ä»æ¶ˆæ¯é˜Ÿåˆ—æˆ–è€…å»¶è¿Ÿé˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡å¹¶æ‰§è¡Œä»»åŠ¡ã€‚

è¿™äº›ä»»åŠ¡å°±æ˜¯`å®ä»»åŠ¡`

å®ä»»åŠ¡çš„æ—¶é—´ç²’åº¦æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œå¦‚æœé‡åˆ°ä¸€äº›å¯¹å®æ—¶æ€§è¦æ±‚æ¯”è¾ƒé«˜çš„ä»»åŠ¡ï¼ˆå®æ—¶ç›‘å¬DOMï¼‰ï¼Œå®ä»»åŠ¡å¹¶ä¸èƒ½æ»¡è¶³ï¼Œå› æ­¤äº§ç”Ÿäº†å¾®ä»»åŠ¡

#### å¾®ä»»åŠ¡

**å¾®ä»»åŠ¡å°±æ˜¯ä¸€ä¸ªéœ€è¦æ‰§è¡Œçš„å¼‚æ­¥å‡½æ•°ï¼Œæ‰§è¡Œæ—¶æœºæ˜¯åœ¨ä¸»å‡½æ•°æ‰§è¡Œç»“æŸä¹‹åï¼Œå½“å‰å®ä»»åŠ¡ç»“æŸä¹‹å‰**

ç»“åˆV8å±‚é¢ç†è§£å¾®ä»»åŠ¡

é‡åˆ°ä¸€æ®µJSä»£ç ï¼ŒV8ä¼šåˆ›å»ºå…¨å±€ä¸Šä¸‹æ–‡ï¼ŒåŒæ—¶åˆ›å»ºå¾®ä»»åŠ¡é˜Ÿåˆ—ç”¨æ¥å­˜æ”¾å¾®ä»»åŠ¡ï¼Œåœ¨å½“å‰å®ä»»åŠ¡æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¼šäº§ç”Ÿå¤šä¸ªå¾®ä»»åŠ¡ï¼Œè¿™ä¸ªå¾®ä»»åŠ¡é˜Ÿåˆ—æ˜¯ç»™V8å¼•æ“èƒŒéƒ¨ä½¿ç”¨çš„ï¼ŒJSä¸èƒ½è°ƒç”¨

**å¾®ä»»åŠ¡äº§ç”Ÿæ—¶æœºå’Œæ‰§è¡Œæ—¶æœº**

1. äº§ç”Ÿæ—¶æœº - ç°ä»£æµè§ˆå™¨
2. ä½¿ç”¨MutationObserveç›‘å¬æŸä¸ªDOMèŠ‚ç‚¹ï¼Œé€šè¿‡JSä¿®æ”¹è¿™ä¸ªèŠ‚ç‚¹ï¼ŒDOMèŠ‚ç‚¹å‘ç”Ÿå˜åŒ–ï¼Œå°±ä¼šäº§ç”ŸDOMå˜åŒ–çš„å¾®ä»»åŠ¡
3. ä½¿ç”¨Promise è°ƒç”¨Promise.resolve å’Œ Promise.reject
4. æ‰§è¡Œæ—¶æœº

åœ¨å½“å‰å®ä»»åŠ¡ä¸­JSæ‰§è¡Œå¿«å®Œæˆæ—¶ï¼Œå°±åœ¨JavaScriptå¼•æ“å‡†å¤‡é€€å‡ºå…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡å¹¶æ¸…ç©ºè°ƒç”¨æ ˆçš„æ—¶å€™ï¼ŒJSå¼•æ“ä¼šæ£€æŸ¥å…¨å±€ä¸Šä¸‹æ–‡ä¸­çš„å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œç„¶åæŒ‰ç…§é¡ºåºæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œæ‰§è¡Œå¾®ä»»åŠ¡çš„æ—¶é—´ç‚¹`æ£€æŸ¥ç‚¹`

å¦‚æœåœ¨æ‰§è¡Œå¾®ä»»åŠ¡çš„åŒæ—¶ï¼Œäº§ç”Ÿäº†æ–°çš„å¾®ä»»åŠ¡ï¼Œåˆ™å°†æ”¹å¾®ä»»åŠ¡æ·»åŠ åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼ŒV8å¼•æ“ä¼šå¾ªç¯æ‰§è¡Œå¾®ä»»åŠ¡é˜Ÿåˆ—

ç›´è§‚çš„çœ‹ä¸ªä¾‹å­ 

![å¾®ä»»åŠ¡æ‰§è¡Œæ—¶æœº](https://cdn.jsdelivr.net/gh/Wangbaoqi/blogImgs@master/nateImgs/JavaScript/ctx/event\_7.png)

![å¾®ä»»åŠ¡æ‰§è¡Œæ—¶æœº](https://cdn.jsdelivr.net/gh/Wangbaoqi/blogImgs@master/nateImgs/JavaScript/ctx/event\_8.png)

ä»ä¸Šè¿°å¯ä»¥å¾—åˆ°ä»¥ä¸‹ç»“è®ºï¼š

* å¾®ä»»åŠ¡å’Œå®ä»»åŠ¡æ˜¯ç»‘å®šçš„ï¼Œæ¯ä¸ªå®ä»»åŠ¡åœ¨æ‰§è¡Œæ—¶ï¼Œä¼šåˆ›å»ºè‡ªå·±çš„å¾®ä»»åŠ¡é˜Ÿåˆ—
* å¾®ä»»åŠ¡æ‰§è¡Œçš„æ—¶é•¿ï¼Œä¼šå½±å“å½“å‰å®ä»»åŠ¡çš„æ‰§è¡Œæ—¶é•¿ã€‚
* åœ¨ä¸€ä¸ªå®ä»»åŠ¡ä¸­åˆ›å»ºäº†ä¸€ä¸ªç”¨äºå›è°ƒçš„å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡ï¼Œæ— è®ºä»€ä¹ˆæƒ…å†µä¸‹ï¼Œå¾®ä»»åŠ¡éƒ½ä¼šæ—©äºå®ä»»åŠ¡æ‰§è¡Œ

**ç›‘å¬DOMå˜åŒ–**

éšç€ç°åœ¨webåº”ç”¨çš„å¤æ‚åº¦æå‡ï¼Œå¯¹é¡µé¢çš„æ€§èƒ½è¦æ±‚é«˜çš„å‰æä¸‹ï¼Œå¯¹äºDOMçš„æ“ä½œä¹Ÿé€æ¸çš„å†æ›´æ–°ã€‚ æ—©æœŸå¯¹äºé¡µé¢DOMçš„ç›‘å¬ï¼Œæ˜¯ä½¿ç”¨è½®è¯¢çš„æ–¹å¼ï¼Œä½¿ç”¨å®šæ—¶å™¨æ¥æ£€æµ‹DOMæ˜¯å¦æœ‰å˜åŒ–ã€‚åæ¥å¼•å…¥äº†mutationEventï¼Œé‡‡ç”¨è§‚å¯Ÿè€…æ¨¡å¼ã€‚ä¹‹ååˆå¼•å…¥äº†mutationObserver,è§£å†³äº†mutationEventæ‰€å¸¦æ¥çš„çš„é—®é¢˜

1. è½®è¯¢çš„æ–¹å¼ - å¸¦æ¥çš„é—®é¢˜
   * å®šæ—¶å™¨çš„è®¾ç½®æ—¶é•¿ä¸ç¡®å®šï¼Œå¤ªé•¿æµªè´¹æ—¶é—´æˆæœ¬ï¼ŒDOMç›¸åº”ä¸åŠæ—¶
   * è®¾ç½®æ—¶é—´å¤ªçŸ­ï¼Œæµªè´¹æ— ç”¨çš„å·¥ä½œæ£€æŸ¥DOM
2. mutationEvent - å¸¦æ¥çš„é—®é¢˜
   * é‡‡ç”¨è§‚å¯Ÿè€…æ¨¡å¼ï¼ŒDOMä¸€å˜åŒ–ï¼Œè°ƒç”¨å¯¹åº”çš„å›è°ƒæ›´æ–°ï¼Œè¿™ç§å›è°ƒæ˜¯åŒæ­¥å›è°ƒ
   * ä¸€æ—¦ä¸€æ¬¡åŠ¨æ€ä¿®æ”¹å¤šä¸ªèŠ‚ç‚¹å†…å®¹ï¼Œå°±ä¼šè§¦å‘å¤šä¸ªå›è°ƒï¼Œæ¯ä¸ªå›è°ƒæ‰§è¡Œæ—¶é—´å›ºå®šçš„è¯ï¼Œé‚£æ›´æ–°DOMçš„æ€»å…±è€—æ—¶å°±ä¼šå˜çš„å¾ˆé•¿ï¼Œæœ€ç»ˆä¼šå¯¼è‡´é¡µé¢æ€§èƒ½çš„é—®é¢˜
3. mutationObserver
   * å°†mutationEventçš„å›è°ƒæ–¹å¼æ”¹å˜æˆäº†å¼‚æ­¥ï¼Œä¸ç”¨æ¯æ¬¡å»è§¦å‘å¼‚æ­¥è°ƒç”¨ï¼Œè€Œæ˜¯ç­‰å¤šæ¬¡DOMæ“ä½œä¹‹åï¼Œå†å»è§¦å‘DOMæ›´æ–°
   * é‡‡ç”¨ `å¼‚æ­¥ + å¾®ä»»åŠ¡`ç­–ç•¥
   * å¼‚æ­¥è§£å†³äº†æ€§èƒ½é—®é¢˜
   * å¾®ä»»åŠ¡è§£å†³äº†å®æ—¶æ€§çš„é—®é¢˜

**mutationObserverå’Œå¾®ä»»åŠ¡è”ç³»**

mutationObserverå°†DOMæ›´æ–°å°è£…æˆå¼‚æ­¥ã€‚å½“å‰å®ä»»åŠ¡ä¸­æœ‰æ“ä½œDOMçš„æ“ä½œï¼Œå°±ä¼šå°†è¿™äº›æ›´æ–°DOMçš„å¼‚æ­¥å›è°ƒæ·»åŠ åˆ°å½“å‰å®ä»»åŠ¡ä¸­çš„å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œå½“å‰å®ä»»åŠ¡æ‰§è¡Œç»“æŸä¹‹åï¼ˆæ£€æŸ¥ç‚¹ï¼‰ï¼Œå°±ä¼šæ‰§è¡Œè¿™äº›å¾®ä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯æ›´æ–°å¾®ä»»åŠ¡çš„å›è°ƒ

### Promise å‘Šåˆ«å›è°ƒ

promiseå·²ç»æˆä¸ºäº†å‰ç«¯è§£å†³å¼‚æ­¥çš„ä¸»åŠ›ï¼Œæ¥ä¸‹æ¥å…·ä½“çš„å­¦ä¹ promise

**å¼‚æ­¥ç¼–ç¨‹çš„é—®é¢˜-ä»£ç é€»è¾‘ä¸è¿ç»­**

![å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹](https://cdn.jsdelivr.net/gh/Wangbaoqi/blogImgs@master/nateImgs/JavaScript/ctx/event\_9.png)

ä¸Šè¿°æ˜¯webå¼‚æ­¥ç¼–ç¨‹æ¨¡å‹ æ¥ä¸‹æ¥çœ‹ä¸‹ä¼ ç»Ÿçš„å¼‚æ­¥å›è°ƒå¸¦æ¥çš„é—®é¢˜

```javascript
function requset(url) {
  return {
    url: url,
    method: 'GET',
    timeout: 3000,
    aync: true,
    responseType: 'text',
  }
}
// å°è£…XMLHttpRequest è¯·æ±‚
function Fetch(request, resolve, reject) {
  var xhr = new XMLHttpRequset()

  xhr.onreadystatechange = function() {
    if(this.status == 200) {
      resolve(xhr.respose)
    }
  }
  xhr.ontimeout = function() { reject() }
  xhr.onerror = function() { reject() }
  xhr.open(requset.method, request.url, request.sync)
  xhr.timeout = request.timeout
  xhr.responseType = request.responseType
  xhr.send()
}

// è°ƒç”¨å°è£…è¯·æ±‚
Fetch(request('/api/list'), (data) => {
  console.log(data)
}, (error) => {
  console.log(error)
})
```

æˆªæ­¢ç›®å‰ï¼Œå°è£…åçš„è¯·æ±‚å¯¹äºå•ä¸ªè¯·æ±‚æˆ–è€…ç®€å•è¯·æ±‚æ˜¯å®Œç¾çš„ï¼Œä½†æ˜¯å¦‚æœé‡åˆ°åµŒå¥—è°ƒç”¨ï¼Œå¦‚æœæœ‰å¾ˆå¤šåµŒå¥—æ—¶ï¼Œå°±ä¼šé™·å…¥å›è°ƒåœ°ç‹±ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä»£ç ï¼š

```javascript
Fetch(request('/api/list'), (data) => {
  console.log(data)
  Fetch(request('/api/list'), (data) => {
    console.log(data)
    Fetch(request('/api/list'), (data) => {
      console.log(data)
    }, (error) => {
      console.log(error)
    })
  }, (error) => {
    console.log(error)
  })
}, (error) => {
  console.log(error)
})
```

åµŒå¥—å±‚çº§ä¸€å¤šï¼Œå°±ä¼šç»™äººä¸€ç§å‡Œä¹±çš„æ„Ÿè§‰ï¼Œä»£ç ç»“æ„å¾ˆä¹±ã€‚æ‰€ä»¥ï¼Œéœ€è¦è§£å†³è¿™ç§é—®é¢˜ã€‚

* åµŒå¥—å±‚çº§å¤š - è§£å†³åµŒå¥—è°ƒç”¨
* ä»»åŠ¡çš„ä¸ç¡®å®šæ€§ æ¯æ¬¡è¯·æ±‚éƒ½ä¼šæœ‰é”™è¯¯å¤„ç† - åˆå¹¶é”™è¯¯å¤„ç†

éšç€è¿™ä¸¤ä¸ªé—®é¢˜å‡ºç°ï¼Œ`Promise`å°±ç™»åœºäº†ï¼Œä¸‹é¢ä»£ç æ˜¯æ€ä¹ˆè§£å†³è¿™ä¸¤ä¸ªé—®é¢˜çš„

```javascript
// å°†XMLHttpRequest ä½¿ç”¨Promiseå°è£…
function XFetch(request) {
  return new Promise((resolve, reject) => {
    var xhr = new XMLHttpRequset()

    xhr.onreadystatechange = function() {
      if(this.status == 200 && this.readyStatus === 4) {
        resolve(this.response)
      }else {
        reject({
          error: this.response
        })
      }
    }
    xhr.ontimeout = function() { reject() }
    xhr.onerror = function() { reject() }
    xhr.open(requset.method, request.url, request.sync)
    xhr.timeout = request.timeout
    xhr.responseType = request.responseType
    xhr.send()
  })
}

let x1 = XFetch(request('/api/list'))
let x2 = x1.then(res => {
  console.log(res)
  return XFetch(request('/api/list?type=1'))
})
x2.then(res => {
  console.log(res)
}).catch(err => {
  console.log(err)
})
```

**Promise æ€ä¹ˆè§£å†³åµŒå¥—å›è°ƒé—®é¢˜**

1. Promise å®ç°äº†å›è°ƒå‡½æ•°å»¶æ—¶ç»‘å®š

```javascript
// æ‰§è¡Œä¸šåŠ¡é€»è¾‘
function executor(resolve, reject) {
  resolve(2)
}
let x1 = new Promise(executor)
// å»¶è¿Ÿç»‘å®šå›è°ƒå‡½æ•° 
function cbResolve(val) {
  console.log(val)
}
// é€šè¿‡thenå»¶æ—¶ç»‘å®š
x1.then(cbResolve)
```

   2\. å›è°ƒå‡½æ•°è¿”å›å€¼ç©¿é€åˆ°æœ€å¤–å±‚

```javascript
// æ‰§è¡Œä¸šåŠ¡é€»è¾‘
function executor(resolve, reject) {
  resolve(2)
}
let x1 = new Promise(executor)
// å»¶è¿Ÿç»‘å®šå›è°ƒå‡½æ•° 
function cbResolve(val) {
  console.log(val)
  return new Promise((resolve, reject) => {
    resolve(300 + val)
  })
}
// é€šè¿‡thenå»¶æ—¶ç»‘å®š è¿”å›promiseå¯¹è±¡ å°†å†…éƒ¨è¿”å›å€¼ç©¿é€åˆ°æœ€å¤–å±‚
let x2 = x1.then(cbResolve)
x2.then(result => {
  console.log(result)
})
```

**Promiseå’Œå¾®ä»»åŠ¡**

ä¸‹é¢ç®€å•çš„å®ç°promise, äº†è§£å›è°ƒå‡½æ•°çš„å»¶è¿Ÿç»‘å®šæŠ€æœ¯ï¼Œä»¥åŠäº†è§£promiseçš„å†…éƒ¨çš„åŸç†

```javascript
function BPromise(executor) {
  let _onResolve = null
  let _onReject = null

  this.then = function(onresolve, onreject) {
    _onResolve = onresolve
  }
  function resolve(val) {
    // è®¾ç½®å»¶è¿Ÿç»‘å®šå›è°ƒ 
    // promiseå°†å®šæ—¶å™¨ æ”¹æˆäº†å¾®ä»»åŠ¡çš„æ–¹å¼
    setTimeout(() => {
      _onResolve()
    }, 0)
  }
  executor(resolve, null)
}

function executor(resolve, reject) {
  resolve(200)
}
let bpromise = new BPromise(executor)

bpromise.then(val => {
  console.log(val)
})
```

### async/await åŒæ­¥çš„æ–¹å¼

ä½¿ç”¨promiseèƒ½å¤Ÿå¾ˆå¥½çš„è§£å†³å›è°ƒåœ°ç‹±çš„é—®é¢˜ï¼Œä½†æ˜¯ä¹Ÿä¼šæœ‰è¯­ä¹‰åŒ–ä¸æ˜æ˜¾çš„é—®é¢˜ï¼Œå¤„ç†æµç¨‹å¤æ‚æˆ–è€…ä¸šåŠ¡é€»è¾‘å¤šï¼Œä½¿ç”¨thenå°±ä¼šå¸¦æ¥ä¸èƒ½æ˜æ˜¾è¡¨ç¤ºæ‰§è¡Œæµç¨‹ï¼Œæ¯”å¦‚åµŒå¥—è°ƒç”¨apiå±‚çº§è¾ƒå¤šæ—¶ã€‚

åŸºäºè¿™ä¸ªåŸå› ï¼ŒES7å¼•å…¥äº†asyncå’Œawait, **åœ¨ä¸é˜»å¡ä¸»çº¿ç¨‹çš„æƒ…å†µä¸‹ä½¿ç”¨åŒæ­¥ä»£ç å®ç°å¼‚æ­¥è®¿é—®èµ„æºçš„èƒ½åŠ›ï¼Œæ˜¯ä»£ç é€»è¾‘æ›´æ¸…æ™°**

```javascript
async function foo() {
  let result = await fetch(url)
  let resultall = await fetch(url1)
  conosle.log(result)
  conosle.log(resultall)
}
```

ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œå¯ä»¥ä»¥åŒæ­¥çš„æ–¹å¼è·å–èµ„æºå†…å®¹ï¼Œå¾ˆç›´è§‚çš„ä»£ç ç¼–å†™æ–¹å¼ã€‚ ä¸‹é¢æ¥è¿›ä¸€æ­¥å­¦ä¹ ï¼Œåº•å±‚æ˜¯æ€ä¹ˆå·¥ä½œçš„

**ç”Ÿæˆå™¨å’Œåç¨‹**

* ç”Ÿæˆå™¨å‡½æ•° - å®ƒæ˜¯ä¸€ä¸ªå¸¦æ˜Ÿå·çš„å‡½æ•°ï¼Œå¯ä»¥æš‚åœå’Œæ¢å¤æ‰§è¡Œçš„

```javascript
function* genDemo() {
  console.log('first executer')
  yield 'generator 1'

  console.log('second executer')
  yield 'generator 2'

  console.log('third executer')
  yield 'generator 3'

  console.log('end executer')
  return 'generator 4'
}
console.log('start main0')
let gen = genDemo()
console.log(gen.next().value)

console.log('start main1')
console.log(gen.next().value)
```

å¯ä»¥ä»æ‰“å°ç»“æœçœ‹åˆ°ï¼Œgeneratorå‡½æ•°å¹¶ä¸æ˜¯ä¸€æ¬¡æ€§æ‰§è¡Œç»“æŸçš„ï¼Œä½¿ç”¨æ–¹å¼:

* é‡åˆ°`yield`çš„å…³é”®å­—ï¼ŒJSå¼•æ“å°±ä¼šè¿”å›å…³é”®å­—åé¢çš„å†…å®¹ç»™å¤–éƒ¨ã€‚å¹¶æš‚å®šè¯¥å‡½æ•°çš„æ‰§è¡Œ
* å¤–éƒ¨å‡½æ•°é€šè¿‡`next()`æ–¹æ³•æ¢å¤å‡½æ•°çš„æ‰§è¡Œ

**JS å¼•æ“æ˜¯å¦‚ä½•å®ç°ä¸€ä¸ªå‡½æ•°æš‚åœå’Œæ¢å¤çš„**

é¦–å…ˆè¦äº†è§£`åç¨‹`çš„æ¦‚å¿µ: æ˜¯ä¸€ç§æ¯”çº¿ç¨‹æ›´åŠ è½»é‡çº§çš„å­˜åœ¨ã€‚

1. åç¨‹çœ‹åšæ˜¯ä¸»çº¿ç¨‹ä¸Šçš„ä»»åŠ¡
2. ä¸€ä¸ªçº¿ç¨‹å¯ä»¥å­˜åœ¨å¤šä¸ªåç¨‹ï¼Œåœ¨çº¿ç¨‹ä¸Šåªèƒ½æ‰§è¡Œä¸€ä¸ªåç¨‹
3. å¦‚æœAåç¨‹å¯åŠ¨Båç¨‹ï¼Œå°±æŠŠAåç¨‹ç§°ä¸ºBåç¨‹çš„çˆ¶åç¨‹
4. åç¨‹æ˜¯ç”±ç”¨æˆ·æ€æ§åˆ¶çš„
5. é€šè¿‡returné€€å‡ºåç¨‹

å¯ä»¥çœ‹ä¸€ä¸‹åç¨‹çš„æ‰§è¡Œå›¾

![åç¨‹æµç¨‹å›¾](https://cdn.jsdelivr.net/gh/Wangbaoqi/blogImgs@master/nateImgs/JavaScript/ctx/event\_10.png) 

![åç¨‹è°ƒç”¨æ ˆ](https://cdn.jsdelivr.net/gh/Wangbaoqi/blogImgs@master/nateImgs/JavaScript/ctx/event\_11.png)
